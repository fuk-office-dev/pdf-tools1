<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFç·¨é›†ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .upload-section {
            background: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            border: 3px dashed #ccc;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }

        .upload-section.dragover {
            border-color: #007bff;
            background-color: #e6f2ff;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .file-input-label:hover {
            background-color: #0056b3;
        }

        input[type="file"] {
            display: none;
        }

        .editor-container {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            padding: 5px 10px;
            border-right: 1px solid #ddd;
        }

        .tool-group:last-child {
            border-right: none;
        }

        .tool-button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tool-button:hover {
            background: #e9ecef;
        }

        .tool-button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .color-picker {
            width: 40px;
            height: 35px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .canvas-container {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            display: inline-block;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .canvas-wrapper {
            text-align: center;
            margin-bottom: 20px;
        }

        #pdfCanvas {
            display: block;
            cursor: crosshair;
        }

        #annotationCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .page-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .page-controls button {
            padding: 5px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .page-controls button:hover {
            background: #0056b3;
        }

        .page-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .save-button {
            padding: 12px 40px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .save-button:hover {
            background: #218838;
        }

        .font-size-selector {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .text-input-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .text-input-popup textarea {
            width: 300px;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
        }

        .text-input-popup button {
            margin-top: 10px;
            padding: 8px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .text-input-popup .ok-button {
            background: #007bff;
            color: white;
        }

        .text-input-popup .cancel-button {
            background: #6c757d;
            color: white;
        }

        .stamp-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stamp-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .stamp-option:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .stamp-popup button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #6c757d;
            color: white;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .info-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .line-width-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .line-width-selector input {
            width: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDFç·¨é›†ãƒ„ãƒ¼ãƒ«</h1>
        <p class="subtitle">PDFã«æ³¨é‡ˆã€ãƒ†ã‚­ã‚¹ãƒˆã€å›³å½¢ã‚’è¿½åŠ ã§ãã¾ã™ã€‚ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã¾ã™ã€‚</p>

        <div class="upload-section" id="uploadSection">
            <p style="font-size: 18px; color: #666; margin-bottom: 15px;">
                ğŸ“„ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯
            </p>
            <label for="pdfFile" class="file-input-label">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </label>
            <input type="file" id="pdfFile" accept=".pdf">
        </div>

        <div class="editor-container" id="editorContainer">
            <div class="info-message">
                ğŸ’¡ ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦PDFä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç·¨é›†ã§ãã¾ã™ã€‚ç·¨é›†å¾Œã¯å¿…ãšã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
            </div>

            <div class="toolbar">
                <div class="tool-group">
                    <button class="tool-button" id="selectTool" title="é¸æŠ">ğŸ–±ï¸ é¸æŠ</button>
                </div>
                
                <div class="tool-group">
                    <button class="tool-button" id="textTool" title="ãƒ†ã‚­ã‚¹ãƒˆ">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
                    <select class="font-size-selector" id="fontSize">
                        <option value="10">10pt</option>
                        <option value="12" selected>12pt</option>
                        <option value="14">14pt</option>
                        <option value="16">16pt</option>
                        <option value="18">18pt</option>
                        <option value="20">20pt</option>
                        <option value="24">24pt</option>
                    </select>
                </div>

                <div class="tool-group">
                    <button class="tool-button" id="highlightTool" title="ãƒã‚¤ãƒ©ã‚¤ãƒˆ">ğŸ–ï¸ ãƒã‚¤ãƒ©ã‚¤ãƒˆ</button>
                    <button class="tool-button" id="underlineTool" title="ä¸‹ç·š">UÌ² ä¸‹ç·š</button>
                    <button class="tool-button" id="strikethroughTool" title="æ‰“æ¶ˆã—ç·š">SÌ¶ æ‰“æ¶ˆã—</button>
                </div>

                <div class="tool-group">
                    <button class="tool-button" id="rectangleTool" title="å››è§’">â–¡ å››è§’</button>
                    <button class="tool-button" id="circleTool" title="å††">â—‹ å††</button>
                    <button class="tool-button" id="lineTool" title="ç›´ç·š">â”€ ç›´ç·š</button>
                    <button class="tool-button" id="arrowTool" title="çŸ¢å°">â†’ çŸ¢å°</button>
                </div>

                <div class="tool-group">
                    <button class="tool-button" id="stampTool" title="ã‚¹ã‚¿ãƒ³ãƒ—">ğŸ”– ã‚¹ã‚¿ãƒ³ãƒ—</button>
                </div>

                <div class="tool-group">
                    <input type="color" id="colorPicker" class="color-picker" value="#ff0000" title="è‰²">
                    <div class="line-width-selector">
                        <label style="font-size: 12px;">å¤ªã•:</label>
                        <input type="number" id="lineWidth" min="1" max="10" value="2" style="width: 50px; padding: 5px;">
                    </div>
                </div>

                <div class="tool-group">
                    <button class="tool-button" id="undoButton" title="å…ƒã«æˆ»ã™">â†¶ å…ƒã«æˆ»ã™</button>
                    <button class="tool-button" id="clearButton" title="ã™ã¹ã¦ã‚¯ãƒªã‚¢">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="canvas-wrapper">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                    <canvas id="annotationCanvas"></canvas>
                </div>
            </div>

            <div class="controls">
                <div class="page-controls">
                    <button id="prevPage">å‰ã®ãƒšãƒ¼ã‚¸</button>
                    <span id="pageInfo">ãƒšãƒ¼ã‚¸: 1 / 1</span>
                    <button id="nextPage">æ¬¡ã®ãƒšãƒ¼ã‚¸</button>
                </div>
                <button class="save-button" id="saveButton">ğŸ’¾ ç·¨é›†ã‚’ä¿å­˜ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="overlay" id="overlay"></div>
    <div class="text-input-popup" id="textInputPopup">
        <h3>ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</h3>
        <textarea id="textInput" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›..."></textarea>
        <div>
            <button class="ok-button" id="textOkButton">OK</button>
            <button class="cancel-button" id="textCancelButton">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="stamp-popup" id="stampPopup">
        <h3>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸æŠ</h3>
        <div class="stamp-grid">
            <div class="stamp-option" data-stamp="æ‰¿èª">âœ… æ‰¿èª</div>
            <div class="stamp-option" data-stamp="ç¢ºèª">ğŸ‘ï¸ ç¢ºèª</div>
            <div class="stamp-option" data-stamp="é‡è¦">âš ï¸ é‡è¦</div>
            <div class="stamp-option" data-stamp="æ¸ˆ">âœ“ æ¸ˆ</div>
            <div class="stamp-option" data-stamp="ä¿ç•™">â¸ï¸ ä¿ç•™</div>
            <div class="stamp-option" data-stamp="è¦ä¿®æ­£">âŒ è¦ä¿®æ­£</div>
        </div>
        <button id="stampCancelButton">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pdfBytes = null;
        let currentPage = 1;
        let totalPages = 0;
        let currentTool = 'select';
        let isDrawing = false;
        let startX, startY;
        let annotations = {};
        let currentColor = '#ff0000';
        let currentFontSize = 12;
        let currentLineWidth = 2;
        let textPosition = null;
        let selectedStamp = null;

        const uploadSection = document.getElementById('uploadSection');
        const pdfFileInput = document.getElementById('pdfFile');
        const editorContainer = document.getElementById('editorContainer');
        const pdfCanvas = document.getElementById('pdfCanvas');
        const annotationCanvas = document.getElementById('annotationCanvas');
        const ctx = annotationCanvas.getContext('2d');
        const pageInfo = document.getElementById('pageInfo');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const saveButton = document.getElementById('saveButton');
        const colorPicker = document.getElementById('colorPicker');
        const fontSizeSelector = document.getElementById('fontSize');
        const lineWidthInput = document.getElementById('lineWidth');
        const textInputPopup = document.getElementById('textInputPopup');
        const textInput = document.getElementById('textInput');
        const overlay = document.getElementById('overlay');
        const stampPopup = document.getElementById('stampPopup');

        // ãƒ„ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
        const tools = {
            select: document.getElementById('selectTool'),
            text: document.getElementById('textTool'),
            highlight: document.getElementById('highlightTool'),
            underline: document.getElementById('underlineTool'),
            strikethrough: document.getElementById('strikethroughTool'),
            rectangle: document.getElementById('rectangleTool'),
            circle: document.getElementById('circleTool'),
            line: document.getElementById('lineTool'),
            arrow: document.getElementById('arrowTool'),
            stamp: document.getElementById('stampTool')
        };

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            }
        });

        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            const arrayBuffer = await file.arrayBuffer();
            pdfBytes = arrayBuffer;
            
            const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
            pdfDoc = await loadingTask.promise;
            totalPages = pdfDoc.numPages;
            
            uploadSection.style.display = 'none';
            editorContainer.style.display = 'block';
            
            renderPage(1);
        }

        async function renderPage(pageNumber) {
            currentPage = pageNumber;
            const page = await pdfDoc.getPage(pageNumber);
            
            const viewport = page.getViewport({scale: 1.5});
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;
            annotationCanvas.height = viewport.height;
            annotationCanvas.width = viewport.width;

            const renderContext = {
                canvasContext: pdfCanvas.getContext('2d'),
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            
            pageInfo.textContent = `ãƒšãƒ¼ã‚¸: ${currentPage} / ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            
            redrawAnnotations();
        }

        // ãƒ„ãƒ¼ãƒ«é¸æŠ
        Object.keys(tools).forEach(toolName => {
            tools[toolName].addEventListener('click', () => {
                currentTool = toolName;
                Object.values(tools).forEach(btn => btn.classList.remove('active'));
                tools[toolName].classList.add('active');
                
                if (toolName === 'stamp') {
                    showStampPopup();
                }
            });
        });

        colorPicker.addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        fontSizeSelector.addEventListener('change', (e) => {
            currentFontSize = parseInt(e.target.value);
        });

        lineWidthInput.addEventListener('change', (e) => {
            currentLineWidth = parseInt(e.target.value);
        });

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        annotationCanvas.addEventListener('mousedown', (e) => {
            if (currentTool === 'select') return;
            
            const rect = annotationCanvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            
            if (currentTool === 'text') {
                textPosition = {x: startX, y: startY};
                showTextInput();
            } else if (currentTool === 'stamp' && selectedStamp) {
                addAnnotation({
                    type: 'stamp',
                    x: startX,
                    y: startY,
                    text: selectedStamp,
                    color: currentColor,
                    fontSize: currentFontSize
                });
                selectedStamp = null;
            } else {
                isDrawing = true;
            }
        });

        annotationCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            
            const rect = annotationCanvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            redrawAnnotations();
            drawPreview(startX, startY, currentX, currentY);
        });

        annotationCanvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            
            const rect = annotationCanvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;
            
            addAnnotation({
                type: currentTool,
                x1: startX,
                y1: startY,
                x2: endX,
                y2: endY,
                color: currentColor,
                lineWidth: currentLineWidth
            });
            
            isDrawing = false;
        });

        function drawPreview(x1, y1, x2, y2) {
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentLineWidth;
            ctx.fillStyle = currentColor;
            
            switch(currentTool) {
                case 'rectangle':
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    ctx.beginPath();
                    ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                case 'line':
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                case 'arrow':
                    drawArrow(x1, y1, x2, y2);
                    break;
                case 'highlight':
                    ctx.globalAlpha = 0.3;
                    ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
                    ctx.globalAlpha = 1.0;
                    break;
                case 'underline':
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y1);
                    ctx.stroke();
                    break;
                case 'strikethrough':
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y1);
                    ctx.stroke();
                    break;
            }
        }

        function drawArrow(x1, y1, x2, y2) {
            const headlen = 15;
            const angle = Math.atan2(y2 - y1, x2 - x1);
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        function addAnnotation(annotation) {
            if (!annotations[currentPage]) {
                annotations[currentPage] = [];
            }
            annotations[currentPage].push(annotation);
            redrawAnnotations();
        }

        function redrawAnnotations() {
            ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
            
            if (!annotations[currentPage]) return;
            
            annotations[currentPage].forEach(ann => {
                ctx.strokeStyle = ann.color;
                ctx.fillStyle = ann.color;
                ctx.lineWidth = ann.lineWidth || 2;
                
                switch(ann.type) {
                    case 'text':
                        ctx.font = `${ann.fontSize}px Arial`;
                        ctx.fillText(ann.text, ann.x, ann.y);
                        break;
                    case 'rectangle':
                        ctx.strokeRect(ann.x1, ann.y1, ann.x2 - ann.x1, ann.y2 - ann.y1);
                        break;
                    case 'circle':
                        const radius = Math.sqrt(Math.pow(ann.x2 - ann.x1, 2) + Math.pow(ann.y2 - ann.y1, 2));
                        ctx.beginPath();
                        ctx.arc(ann.x1, ann.y1, radius, 0, 2 * Math.PI);
                        ctx.stroke();
                        break;
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(ann.x1, ann.y1);
                        ctx.lineTo(ann.x2, ann.y2);
                        ctx.stroke();
                        break;
                    case 'arrow':
                        drawArrow(ann.x1, ann.y1, ann.x2, ann.y2);
                        break;
                    case 'highlight':
                        ctx.globalAlpha = 0.3;
                        ctx.fillRect(ann.x1, ann.y1, ann.x2 - ann.x1, ann.y2 - ann.y1);
                        ctx.globalAlpha = 1.0;
                        break;
                    case 'underline':
                    case 'strikethrough':
                        ctx.beginPath();
                        ctx.moveTo(ann.x1, ann.y1);
                        ctx.lineTo(ann.x2, ann.y1);
                        ctx.stroke();
                        break;
                    case 'stamp':
                        ctx.font = `bold ${ann.fontSize}px Arial`;
                        ctx.fillText(ann.text, ann.x, ann.y);
                        break;
                }
            });
        }

        function showTextInput() {
            overlay.style.display = 'block';
            textInputPopup.style.display = 'block';
            textInput.value = '';
            textInput.focus();
        }

        function hideTextInput() {
            overlay.style.display = 'none';
            textInputPopup.style.display = 'none';
        }

        document.getElementById('textOkButton').addEventListener('click', () => {
            const text = textInput.value.trim();
            if (text && textPosition) {
                addAnnotation({
                    type: 'text',
                    x: textPosition.x,
                    y: textPosition.y,
                    text: text,
                    color: currentColor,
                    fontSize: currentFontSize
                });
            }
            hideTextInput();
            textPosition = null;
        });

        document.getElementById('textCancelButton').addEventListener('click', () => {
            hideTextInput();
            textPosition = null;
        });

        function showStampPopup() {
            overlay.style.display = 'block';
            stampPopup.style.display = 'block';
        }

        function hideStampPopup() {
            overlay.style.display = 'none';
            stampPopup.style.display = 'none';
        }

        document.querySelectorAll('.stamp-option').forEach(option => {
            option.addEventListener('click', () => {
                selectedStamp = option.dataset.stamp;
                hideStampPopup();
            });
        });

        document.getElementById('stampCancelButton').addEventListener('click', () => {
            hideStampPopup();
            selectedStamp = null;
        });

        document.getElementById('undoButton').addEventListener('click', () => {
            if (annotations[currentPage] && annotations[currentPage].length > 0) {
                annotations[currentPage].pop();
                redrawAnnotations();
            }
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            if (confirm('ã“ã®ãƒšãƒ¼ã‚¸ã®ã™ã¹ã¦ã®æ³¨é‡ˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                annotations[currentPage] = [];
                redrawAnnotations();
            }
        });

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                renderPage(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                renderPage(currentPage + 1);
            }
        });

        saveButton.addEventListener('click', async () => {
            try {
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                
                // å„ãƒšãƒ¼ã‚¸ã«æ³¨é‡ˆã‚’è¿½åŠ 
                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    if (!annotations[pageNum] || annotations[pageNum].length === 0) continue;
                    
                    const page = pdfDoc.getPage(pageNum - 1);
                    const { width, height } = page.getSize();
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã¨PDFãƒšãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
                    const scaleX = width / (annotationCanvas.width / 1.5);
                    const scaleY = height / (annotationCanvas.height / 1.5);
                    
                    annotations[pageNum].forEach(ann => {
                        const color = hexToRgb(ann.color);
                        
                        if (ann.type === 'text' || ann.type === 'stamp') {
                            const x = ann.x * scaleX;
                            const y = height - (ann.y * scaleY);
                            page.drawText(ann.text, {
                                x: x,
                                y: y,
                                size: ann.fontSize * scaleY,
                                color: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255)
                            });
                        } else if (ann.type === 'rectangle') {
                            const x = Math.min(ann.x1, ann.x2) * scaleX;
                            const y = height - (Math.max(ann.y1, ann.y2) * scaleY);
                            const w = Math.abs(ann.x2 - ann.x1) * scaleX;
                            const h = Math.abs(ann.y2 - ann.y1) * scaleY;
                            page.drawRectangle({
                                x: x,
                                y: y,
                                width: w,
                                height: h,
                                borderColor: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255),
                                borderWidth: ann.lineWidth
                            });
                        } else if (ann.type === 'highlight') {
                            const x = Math.min(ann.x1, ann.x2) * scaleX;
                            const y = height - (Math.max(ann.y1, ann.y2) * scaleY);
                            const w = Math.abs(ann.x2 - ann.x1) * scaleX;
                            const h = Math.abs(ann.y2 - ann.y1) * scaleY;
                            page.drawRectangle({
                                x: x,
                                y: y,
                                width: w,
                                height: h,
                                color: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255),
                                opacity: 0.3
                            });
                        } else if (ann.type === 'underline' || ann.type === 'strikethrough' || ann.type === 'line') {
                            const x1 = ann.x1 * scaleX;
                            const y1 = height - (ann.y1 * scaleY);
                            const x2 = ann.x2 * scaleX;
                            const y2 = height - (ann.y2 * scaleY);
                            page.drawLine({
                                start: { x: x1, y: y1 },
                                end: { x: x2, y: y2 },
                                thickness: ann.lineWidth,
                                color: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255)
                            });
                        }
                        // å††ã¨çŸ¢å°ã¯pdf-libã§ã¯ç›´æ¥æç”»ã§ããªã„ãŸã‚çœç•¥
                    });
                }
                
                const savedPdfBytes = await pdfDoc.save();
                downloadPDF(savedPdfBytes, 'edited.pdf');
                
                alert('PDFãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
            } catch (error) {
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 0, g: 0, b: 0};
        }

        function downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
